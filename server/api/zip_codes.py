import urllib.request
import simplejson
import os
from dotenv import load_dotenv

load_dotenv()

base_url = 'http://api.earth911.com/'
api_key = os.getenv("API_KEY")

code_to_class = {
        "445": "plastic",
        "60": "plastic",
        "446": "plastic",
        "447": "plastic",
        "449": "plastic",
        "450": "plastic",
        "448": "plastic",
        "93": "plastic",
        "455": "plastic",
        "619": "plastic",
        "452": "plastic",
        "413": "plastic",
        "62": "plastic",
        "61": "plastic",
        "454": "plastic",
        "456": "plastic",
        "63": "plastic",
        "457": "plastic",
        "458": "plastic",
        "708": "plastic",
        "737": "plastic",
        "429": "plastic",
        "64": "plastic",
        "461": "plastic",
        "463": "plastic",
        "464": "plastic",
        "65": "plastic",
        "361": "plastic",
        "465": "plastic",
        "466": "plastic",
        "467": "plastic",
        "468": "plastic",
        "355": "plastic",
        "470": "plastic",
        "66": "plastic",
        "472": "plastic",
        "621": "plastic",
        "471": "plastic",
        "473": "plastic",
        "68": "plastic",
        "475": "plastic",
        "477": "plastic",
        "67": "plastic",
        "478": "plastic",
        "476": "plastic",
        "503": "trash",
        "733": "trash",
        "187": "trash",
        "353": "trash",
        "121": "trash",
        "521": "trash",
        "591": "trash",
        "104": "battery",
        "70": "metal",
        "235": "metal",
        "435": "metal",
        "434": "metal",
        "436": "metal",
        "607": "metal",
        "437": "metal",
        "194": "trash",
        "3": "trash",
        "756": "trash",
        "363": "trash",
        "196": "trash",
        "212": "trash",
        "485": "trash",
        "219": "trash",
        "275": "trash",
        "422": "trash",
        "505": "trash",
        "754": "battery",
        "763": "trash",
        "134": "trash",
        "525": "trash",
        "759": "trash",
        "753": "trash",
        "647": "trash",
        "255": "glass",
        "430": "glass",
        "657": "trash",
        "423": "paper",
        "643": "trash",
        "745": "trash",
        "108": "trash",
        "231": "compost",
        "683": "metal",
        "210": "trash",
        "561": "paper",
        "76": "glass",
        "431": "glass",
        "232": "trash",
        "127": "battery",
        "481": "trash",
        "585": "trash",
        "563": "trash",
        "4": "battery",
        "368": "trash",
        "425": "paper",
        "217": "trash",
        "118": "trash",
        "651": "trash",
        "398": "trash",
        "270": "paper",
        "507": "trash",
        "641": "trash",
        "147": "trash",
        "244": "trash",
        "482": "trash",
        "245": "trash",
        "215": "trash",
        "333": "trash",
        "364": "trash",
        "583": "trash",
        "117": "cardboard",
        "100": "trash",
        "693": "trash",
        "77": "glass",
        "432": "glass",
        "83": "trash",
        "755": "trash",
        "752": "trash",
        "761": "trash",
        "414": "plastic",
        "483": "trash",
        "615": "trash",
        "203": "trash",
        "385": "trash",
        "132": "trash",
        "663": "paper",
        "378": "trash",
        "379": "trash",
        "527": "trash",
        "130": "trash",
        "388": "trash",
        "595": "metal",
        "389": "trash",
        "40": "cardboard",
        "359": "trash",
        "486": "trash",
        "487": "trash",
        "661": "trash",
        "697": "trash",
        "85": "trash",
        "488": "trash",
        "207": "trash",
        "81": "trash",
        "380": "trash",
        "201": "trash",
        "631": "trash",
        "645": "trash",
        "637": "trash",
        "711": "trash",
        "340": "trash",
        "712": "trash",
        "186": "trash",
        "509": "paper",
        "702": "trash",
        "195": "trash",
        "101": "glass",
        "371": "trash",
        "74": "metal",
        "183": "trash",
        "727": "glass",
        "253": "trash",
        "569": "trash",
        "222": "trash",
        "116": "trash",
        "529": "trash",
        "182": "trash",
        "332": "trash",
        "557": "trash",
        "395": "trash",
        "597": "trash",
        "188": "trash",
        "343": "trash",
        "345": "trash",
        "627": "glass",
        "589": "trash",
        "489": "trash",
        "233": "compost",
        "102": "glass",
        "433": "glass",
        "344": "paper",
        "751": "trash",
        "208": "trash",
        "419": "trash",
        "372": "trash",
        "373": "trash",
        "511": "trash",
        "748": "trash",
        "581": "trash",
        "541": "paper",
        "382": "trash",
        "348": "compost",
        "513": "trash",
        "181": "trash",
        "306": "trash",
        "617": "trash",
        "490": "trash",
        "184": "trash",
        "228": "trash",
        "707": "trash",
        "695": "trash",
        "535": "trash",
        "739": "trash",
        "599": "trash",
        "247": "trash",
        "95": "trash",
        "180": "trash",
        "192": "trash",
        "515": "trash",
        "625": "paper",
        "403": "trash",
        "491": "trash",
        "709": "trash",
        "418": "trash",
        "254": "trash",
        "259": "trash",
        "229": "trash",
        "384": "trash",
        "370": "battery",
        "230": "compost",
        "374": "trash",
        "381": "trash",
        "517": "trash",
        "746": "trash",
        "391": "trash",
        "375": "trash",
        "216": "trash",
        "689": "battery",
        "6": "battery",
        "762": "trash",
        "346": "trash",
        "94": "paper",
        "669": "trash",
        "539": "trash",
        "366": "trash",
        "728": "trash",
        "349": "compost",
        "326": "battery",
        "744": "trash",
        "226": "trash",
        "533": "trash",
        "252": "trash",
        "8": "syringe",
        "639": "glass",
        "193": "trash",
        "334": "trash",
        "97": "metal",
        "439": "metal",
        "440": "metal",
        "493": "trash",
        "236": "trash",
        "44": "paper",
        "1": "trash",
        "260": "glass",
        "357": "trash",
        "579": "paper",
        "749": "paper",
        "221": "metal",
        "575": "metal",
        "376": "trash",
        "603": "trash",
        "392": "trash",
        "39": "paper",
        "667": "paper",
        "126": "battery",
        "685": "metal",
        "687": "battery",
        "623": "compost",
        "99": "metal",
        "704": "trash",
        "271": "trash",
        "272": "trash",
        "58": "paper",
        "273": "trash",
        "2": "trash",
        "404": "trash",
        "98": "compost",
        "342": "trash",
        "659": "trash",
        "405": "trash",
        "191": "trash",
        "205": "trash",
        "96": "paper",
        "442": "paper",
        "519": "paper",
        "443": "paper",
        "494": "paper",
        "444": "paper",
        "427": "paper",
        "250": "paper",
        "42": "paper",
        "747": "trash",
        "665": "trash",
        "277": "glass",
        "179": "trash",
        "54": "paper",
        "190": "trash",
        "396": "trash",
        "531": "trash",
        "567": "plastic",
        "593": "plastic",
        "354": "plastic",
        "655": "plastic",
        "537": "plastic",
        "699": "plastic",
        "677": "plastic",
        "500": "plastic",
        "523": "plastic",
        "189": "trash",
        "214": "trash",
        "543": "trash",
        "577": "trash",
        "495": "trash",
        "653": "trash",
        "145": "trash",
        "605": "trash",
        "496": "trash",
        "649": "trash",
        "553": "trash",
        "369": "trash",
        "257": "trash",
        "386": "trash",
        "706": "trash",
        "258": "trash",
        "545": "trash",
        "397": "metal",
        "736": "trash",
        "565": "trash",
        "757": "trash",
        "213": "trash",
        "377": "trash",
        "409": "paper",
        "547": "battery",
        "671": "trash",
        "362": "trash",
        "729": "trash",
        "731": "trash",
        "197": "trash",
        "410": "paper",
        "713": "trash",
        "185": "trash",
        "80": "trash",
        "679": "metal",
        "73": "metal",
        "438": "metal",
        "211": "trash",
        "609": "trash",
        "341": "trash",
        "571": "trash",
        "356": "trash",
        "635": "trash",
        "497": "trash",
        "246": "trash",
        "734": "trash",
        "484": "trash",
        "358": "trash",
        "387": "trash",
        "5": "trash",
        "549": "trash",
        "79": "trash",
        "224": "trash",
        "587": "trash",
        "629": "trash",
        "220": "trash",
        "107": "trash",
        "256": "glass",
        "415": "trash",
        "633": "trash",
        "498": "trash",
        "738": "trash",
        "611": "trash",
        "402": "paper",
        "499": "trash",
        "750": "trash",
        "408": "trash",
        "492": "trash",
        "267": "trash",
        "675": "trash",
        "673": "trash",
        "223": "trash",
        "399": "trash",
        "573": "trash",
        "412": "trash",
        "411": "cardboard",
        "234": "compost",
        "441": "paper",
        "559": "paper",
        "218": "trash",
        "204": "trash",
        "352": "trash",
        "206": "trash",
        "407": "trash",
        "551": "paper",
        "146": "trash",
        "78": "compost",
        "421": "trash",
        "681": "trash",
        "613": "battery",
        "710": "battery",
        "691": "battery",
        "760": "trash"
        }

def query(url):
    with urllib.request.urlopen(url) as response:
        text = response.read().decode('utf-8')
        result = simplejson.loads(text)
        if 'error' in result:
            raise Exception(result['error'])
        else:
            return result['result']

def get_postal_data(country, postal_code):
    url = f"{base_url}earth911.getPostalData?api_key={api_key}&country={country}&postal_code={postal_code}"
    return query(url)

def search_recycling_programs(latitude, longitude, max_distance=25, max_results=5, residential_only=False):
    params = {
        'api_key': api_key,
        'latitude': latitude,
        'longitude': longitude,
        'max_distance': max_distance,
        'max_results': max_results,
        'residential_only': str(residential_only).lower()
    }
    url = f"{base_url}earth911.searchPrograms?" + urllib.parse.urlencode(params, doseq=True)
    return query(url)

def get_program_details(program_id):
    params = {
        'api_key': api_key,
        'program_id': program_id
    }
    url = f"{base_url}earth911.getProgramDetails?" + urllib.parse.urlencode(params, doseq=True)
    return query(url)
